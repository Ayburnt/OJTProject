# This file should be placed in your application bundle at .platform/nginx/conf.d/events-eb.conf
# Ensure no other conflicting .conf files are in this directory.

server {
    listen 80; # REMOVED 'default_server' here, as the custom main nginx.conf will handle it implicitly.
    server_name  _ ; # Listen for any server name. Use your actual domain name if applicable.

    # Serve static files for the React frontend
    # This block processes requests for the root path and assets.
    # It attempts to find the requested URI as a file or directory.
    # If not found, it internally redirects to the named location @proxy_to_react_index.
    location / {
        root /var/app/current/backend/static; # Path to your React build files (where index.html resides)
        index index.html index.htm; # Specify index.html explicitly for this location
        try_files $uri $uri/ /index.html; # Fallback to index.html for client-side routing
    }

    # Proxy API requests to the Django backend
    location /api/ {
        proxy_pass http://localhost:8000; # Assuming your Django backend runs on port 8000
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        # Add any other necessary proxy headers, e.g., for websockets if needed:
        # proxy_set_header Upgrade $http_upgrade;
        # proxy_set_header Connection "upgrade";
    }
    

    # Proxy Django Admin requests
    location /admin/ {
        proxy_pass http://localhost:8000; # Proxy to Django backend for admin
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Serve Django static files directly via Nginx
    # This is for Django's collected static files (e.g., admin static files, or other app static files)
    # Ensure `python manage.py collectstatic` runs during deployment to populate this directory.
    location /static/ {
        alias /var/app/current/backend/staticfiles/; # Corrected path to Django's collected static files
        expires 30d; # Cache static files for 30 days
        add_header Cache-Control "public";
    }

    # Serve Django media files directly via Nginx
    # This is for user-uploaded content or other dynamic media.
    location /media/ {
        alias /var/app/current/media/; # Path where Django stores media files
        expires 30d;
        add_header Cache-Control "public";
    }

    # Error pages (optional, but good for user experience)
    error_page 500 502 503 504 /50x.html;
    location = /50x.html {
        root html; # Nginx's default error page location
    }
}
